---
title: "Missing Data Analysis"
author: "Rani Basna"
date: "2024-01-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#load libraries  and images
```{r}
library(naniar)
library(knitr)
library(missRanger)
library(dplyr)
library(doParallel)
library(psych)
# library(misty)
library(ggpubr)
library(finalfit)
library(haven)
library(vtable)
# install.packages("tableone")
```

# Load and clean the data

```{r}
WSAS_phenotyping_data <- haven::read_spss("../Updated asthma phenotyping files/WSAS_phenotyping_data.sav")
data <- WSAS_phenotyping_data
# dplyr::glimpse(data)
# Take out the ID variables 
# remove variables ID, URVAL, AND COHORT 
data <- data |> select(-ID,-cohort)
#CONVERT ALL CHARACTER VARIABLES INTO FACTORS 
data <-  data |> mutate_if(is.character, as.factor)
# Replace the outliers value 234600 for the Age variable with NA
data$Age[data$Age == 234600] <- NA
# Convert the value of the onset_age_asthma variable for all cases with asthma is 'No' to -1 using tidy approach 
# data$onset_age_asthma[data$asthma == "No"] <- -1
data$onset_age_asthma[data$asthma == "0"] <- -1
```

```{r}
# Count the number of rows which has value -1 for the onset_age_asthma variable
data |> filter(onset_age_asthma == -1) |> nrow()
```


# data Labeling

correctly label the data with two levels
```{r, include=FALSE}
## select all factors with two levels 
twolevs <- data |> select(where(~ nlevels(.x)==3|nlevels(.x)==2), -allergen_triggered_asthma,-exertion_triggered_asthma,-infection_triggered_asthma,-irritant_triggered_asthma,-weather_triggered_asthma,-emotion_triggered_asthma) |> names()

data[twolevs] <- lapply(data[twolevs],function(x) {factor(x,levels = c("0","1"),labels = c("No", "Yes"))})  

Correct_twolevs <-  c("allergen_triggered_asthma", "exertion_triggered_asthma", "infection_triggered_asthma", "irritant_triggered_asthma", "weather_triggered_asthma", "emotion_triggered_asthma") 
```



```{r}
# Apply the function unique to twolevs to check if the labeling is correct
lapply(data[twolevs],unique)
lapply(data[twolevs],str)
lapply(data[FactorVar],str)
lapply(data[FactorVar],levels)
lapply(data[twolevs],levels)

large_levels <- data %>% select(where(~nlevels(.x) > 3)) %>% names()
lapply(data[large_levels],unique)
lapply(data[large_levels],str)
lapply(data[large_levels],levels)
```

## correctly label variable with more than two levels 

```{r include=FALSE}
# Convert education to a factor with specified levels and labels
data$gina_steps <- factor(data$gina_steps, levels = c("0","1","2","3"), labels = c("onlys saba or non users", "step 1 or 2","step3","step4 or 5"))
data$education <- factor(data$education, levels = c("0", "1", "2"), labels = c("primary", "secondary", "tertiary"))
data$smoking_status <- factor(data$smoking_status, levels = c("0", "1", "2"), labels = c("never smoker","former smokers","current smoker"))

# Access the levels of the gina_control variable
current_levels_gina <- levels(data$gina_control)
# Replace the empty string "" with NA in the levels
levels(data$gina_control)[current_levels_gina == ""] <- NA
```

##  Convert to ordinal variables

```{r}
data %>% select(where(is.factor)) %>% names() %>% setdiff(c(Correct_twolevs,twolevs))
data %>% select(where(~nlevels(.x) > 3)) %>% names()
data %>% select(where(~nlevels(.x) > 3))
data %>% select(smoking_status, gina_steps, gina_control, education)
imp_data %>% select(smoking_status, gina_steps, gina_control, education)
```

```{r}
ordinal_varaibles <- data %>% select(where(is.factor)) %>% names() %>% setdiff(c(Correct_twolevs,twolevs))
ordinal_varaibles
# Convert factor to ordinal variables
data[ordinal_varaibles] <- lapply(data[ordinal_varaibles],function(x) {factor(x,ordered = TRUE)})
data %>% select(all_of(ordinal_varaibles)) %>% lapply(levels)
```

```{r}
# get the difference between the features in the data and the imputed data
diff_features <- setdiff(names(data), names(imp_data))
diff_features <- setdiff(names(WSAS_phenotyping_data), names(data))
diff_features
```






# Missing data visualization

Count of missingness in total and in each variable with proportion

```{r}
n_miss(data)
#total observations in the data set
total_observations <- sum(!is.na(data))
#Proportion of missingness
(n_miss(data)/total_observations)*100
#variables with any missing values 
List_variables_with_misisng_values <-  data %>%
  select(where(~ any(is.na(.)))) |> names() |> dput()
#check which variable has missingness
gg_miss_var(data)
gg_miss_upset(data)
#
vis_miss(data %>% select_if(is.factor))
vis_miss(data %>% select_if(is.numeric))
```

```{r}
gg_miss_fct(x = data, fct = onset_age_asthma)
gg_miss_fct(x = data, fct = asthma)
gg_miss_fct(x = data, fct = XCOPD)
```
```{r}
demographics <- data |> select(Age,Gender,BMI,onset_age_asthma) |> names() 
symptoms <- data |>select(Cough,Breathlessness,Recurrent_wheeze,Chronic_productive_cough,dyspenea) |> names() 
functions <- data |> select(FEV1_FVC_ratio_post,Reversibility,pd20,tlco,kco) |> names()
inflammation <- data |> select(FeNO,Eosinophiles,Neutrophiles,Lymphocytes,Monocytes) |> names()
atopy <- data |> select(familial_allergy,Ever_rhinitis,Drug_induced_dyspnea,nasal_plyposis) |> names() 
severity <- data |> select(gina_steps,Hosptalization_last_year,Emergency_last_year,severe_asthma,gina_control) |> names() 
social <- data |> select(education,urbanization_level,smoking_status,pack_years, smoking_exposure_at_home,smoking_exposure_at_work) |> names()
triggers <- data |> select(exertion_triggered_asthma,infection_triggered_asthma,irritant_triggered_asthma,weather_triggered_asthma,allergen_triggered_asthma,emotion_triggered_asthma) |> names() 
comorbid <- data |> select(asthma)|> names()
```

```{r, warning=FALSE, message=FALSE}
# explanatory =  c("Hosptalization_last_year", "Emergency_last_year", "severe_asthma")
explanatory = social
# dependent = "BMI"
dependent = "pack_years"
data %>%  missing_pairs(dependent, explanatory)
```

```{r, warning=FALSE, message=FALSE}
explanatory =  c("Age", "education", "severe_asthma","onset_age_asthma")
# dependent = "BMI"
dependent = "pack_years"
data %>%  missing_pairs(dependent, explanatory)
```

- Older people report more number of pack-years than younger ones
- Older people report education state less than younger ones (one needs to look at the number of missingness here as well as the different education values/labels)
- Number of pack-year are higher among people that do not report education state. Do we need more detailed education? 
- For those who miss the education state, majority miss the pack-years as well compared to other education states.  

```{r, warning=FALSE, message=FALSE}
explanatory =  c("BMI", "Hosptalization_last_year", "severe_asthma","Emergency_last_year","Breathlessness")
# dependent = "BMI"
dependent = "asthma"
data %>%  missing_pairs(dependent, explanatory)
```

```{r, warning=FALSE, message=FALSE}
explanatory = c('nasal_plyposis', 'Hosptalization_last_year', 'Emergency_last_year', 'smoking_status', 'gina_steps', 'severe_asthma')
# dependent = "BMI"
dependent = "asthma"
data %>%  missing_pairs(dependent, explanatory)
```
```{r}
# Plot the density of the BMI variable for the data
ggplot(imp_data, aes(x = Age)) + geom_density()
```
```{r}
aq_shadow <- bind_shadow(data)
```

```{r}
ggplot(aq_shadow, aes(x = Age, colour = BMI_NA)) + geom_density()
```
```{r}
# what if we explore the value of air temperature and humidity based on
# the missingness of each
 aq_shadow %>% ggplot(aes(x = Basophiles, fill = pack_years_NA)) + geom_histogram()
```


# Imputation

```{r}
#For imputaion exclude data on ID variable 
# data <- data |> select(-ID(),- Adult_onset_asthma)
data <- data |> select(- Adult_onset_asthma)
library(doParallel)
cl <- makeCluster(2)
registerDoParallel(cl)

# install.packages("miceRanger")
library(miceRanger)
  seqTime <- system.time(
  miceObj <- miceRanger(
     data
    , m=5
    , returnModels = TRUE
    , verbose=FALSE
  )
)
miceObj
```
```{r}
miceObj <- addIterations(miceObj,iters=5,verbose=TRUE)
miceObj <- addDatasets(miceObj,datasets=5,verbose=TRUE)
miceObj
```

```{r}
# save miceObj as rds file
saveRDS(miceObj, file = "miceObj.rds")
miceObj_test <- readRDS("miceObj.rds")
# save(miceObj, file = "miceObj.RData")
```

```{r}
plotDistributions(miceObj,vars= 'allNumeric')
plotDistributions(miceObj,vars= 'allCategorical')
```
# Post imputation analysis


```{r}
install.packages("VIM")
library(VIM)
library(tibble)
dataList <- completeData(miceObj)
# head(dataList[[1]],10)
imp_data <- dataList[[1]]
```

```{r}
# plot the distribution of the all the factor variables in imp_data
imp_data |> select(where(is.factor)) |> names() |>  purrr::map(~ ggplot(imp_data, aes(x = .data[[.x]])) + geom_bar() + theme(axis.text.x = element_text(angle = 90, hjust = 1)))
```

```{r}
# plot the distribution of the all the factor variables in data after removing the NA values
data |> select(where(is.factor)) |> names() |>  purrr::map(~ ggplot(data, aes(x = .data[[.x]])) + geom_bar() + theme(axis.text.x = element_text(angle = 90, hjust = 1)))
```

```{r}
library(tidyverse)

# Reshape the data into a long format
long_data <- data %>%
  pivot_longer(cols = where(is.factor), names_to = "Variable", values_to = "Value") %>%
  drop_na() %>%
  group_by(Variable, Value) %>%
  summarise(Count = n()) %>%
  mutate(Percent = Count / sum(Count) * 100)

# Plotting each factor variable
ggplot(long_data, aes(x = Value, y = Percent, fill = Value)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ Variable, scales = "free_x") +
  labs(y = "Percentage", x = "") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
plot_factor_distribution <- function(data, factor_var_name) {
    # Check if the specified variable exists and is a factor
    if (!factor_var_name %in% names(data) || !is.factor(data[[factor_var_name]])) {
        stop("The specified variable is not a factor or does not exist in the dataframe.")
    }
  
    # Calculate percentages
    data %>%
        count(!!sym(factor_var_name)) %>%
        mutate(Percent = n / sum(n) * 100) %>%
        ggplot(aes_string(x = factor_var_name, y = "Percent", fill = factor_var_name)) +
        geom_bar(stat = "identity") +
        labs(y = "Percentage", x = factor_var_name) +
        theme_minimal() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
}
```

```{r}
data %>% names()
```

```{r}
library(tidyr)
data
```
```{r}
# sample random number between 1 and 8
# set.seed(123)
dataNumber <- sample(1:8, 1)
dataNumber
imp_data <- dataList[[dataNumber]]
# Usage example:
plot_factor_distribution(imp_data, "asthma")
plot_factor_distribution(imp_data, "gina_control")
# remove all na from the data
# data <- data %>% drop_na()
plot_factor_distribution(imp_data, "smoking_status")
plot_factor_distribution(imp_data, "education")
```
```{r}
# Usage example:
plot_factor_distribution(data, "asthma")
plot_factor_distribution(data, "gina_control")
# remove all na from the data
# data <- data %>% drop_na()
plot_factor_distribution(data, "smoking_status")
plot_factor_distribution(data, "education")
```


```{r}
library(dplyr)
library(tidyr)

vis_miss_relation <- function(data, imp_data, var1, var2) {
    # Check if the specified variables exist
    if (!var1 %in% names(data) || !var2 %in% names(data)) {
        stop("One or both of the specified variables do not exist in the dataframe.")
    }
  
    # Processing the original dataframe
    df_3 <- data %>%
        select({{ var1 }}, {{ var2 }}) %>%
        rename_with(~paste0(., "_imp"), everything()) %>%
        mutate(across(everything(), ~as.logical(ifelse(is.na(.), TRUE, FALSE)))) %>%
        rownames_to_column()

    # Processing the imputed data
    df_4 <- imp_data %>%
        select({{ var1 }}, {{ var2 }}) %>%
        rownames_to_column()

    # Joining the dataframes
    df <- left_join(df_3, df_4, by = "rowname")

    # Return the final dataframe
    return(as.data.frame(df))
}

# Usage example:
# new_df <- vis_miss_relation(your_dataframe, imp_data, "Variable1", "Variable2")
```

```{r}
vis_miss_df <- vis_miss_relation(data, imp_data, "urbanization_level", "FeNO")
vis_miss_df
vars <- c("FeNO","urbanization_level","urbanization_level_imp")
histMiss(vis_miss_df[,vars], delimiter="imp", selection="any")
vars <- c("urbanization_level", "FeNO", "FeNO_imp")
histMiss(vis_miss_df[,vars], delimiter="imp", selection="any")
```
```{r}
vis_miss_df <- vis_miss_relation(data, imp_data, "urbanization_level", "gina_steps")
vis_miss_df
vars <- c("gina_steps","urbanization_level","urbanization_level_imp")
barMiss(vis_miss_df[,vars], delimiter="imp", selection="any")
vars <- c("urbanization_level", "gina_steps","gina_steps_imp")
barMiss(vis_miss_df[,vars], delimiter="imp", selection="any")
```
```{r}
vis_miss_df <- vis_miss_relation(data, imp_data, "smoking_status", "education")
vis_miss_df
vars <- c("education","smoking_status","smoking_status_imp")
barMiss(vis_miss_df[,vars], delimiter="imp", selection="any")
vars <- c("smoking_status", "education","education_imp")
barMiss(vis_miss_df[,vars], delimiter="imp", selection="any")
```

```{r}
vis_miss_df <- vis_miss_relation(data, imp_data, "onset_age_asthma", "BMI")
vis_miss_df
vars <- c("BMI","onset_age_asthma","onset_age_asthma_imp")
marginplot(vis_miss_df[,vars], delimiter="imp", alpha=0.6, pch=c(19))
vars <- c("onset_age_asthma", "BMI","BMI_imp")
marginplot(vis_miss_df[,vars], delimiter="imp", alpha=0.6, pch=c(19))
```

```{r}
vis_miss_df <- vis_miss_relation(data, imp_data, "onset_age_asthma", "pack_years")
vis_miss_df
vars <- c("pack_years","onset_age_asthma","onset_age_asthma_imp")
marginplot(vis_miss_df[,vars], delimiter="imp", alpha=0.6, pch=c(19))
vars <- c("onset_age_asthma", "pack_years","pack_years_imp")
marginplot(vis_miss_df[,vars], delimiter="imp", alpha=0.6, pch=c(19))
```

```{r}
vis_miss_df <- vis_miss_relation(data, imp_data, "Age", "pack_years")
vis_miss_df
vars <- c("pack_years","Age","Age_imp")
marginplot(vis_miss_df[,vars], delimiter="imp", alpha=0.6, pch=c(19))
vars <- c("Age", "pack_years","pack_years_imp")
marginplot(vis_miss_df[,vars], delimiter="imp", alpha=0.6, pch=c(19))
```






















